SCRIPT_DIR="$(dirname "$(realpath "$0")")"
GENERATED_FILE="$SCRIPT_DIR/../internal/tlcodegen/helpers_cpp_generated.go"
BASICTL_CPP_SOURCE="$SCRIPT_DIR/../pkg/basictl_cpp"
COPYRIGHT_TEXT_FILE="$SCRIPT_DIR/../COPYRIGHT"
MOVING_FILES=( \
  "constants.h" \
  "errors.h" \
  "io_connectors.h" \
  "io_streams.cpp" \
  "io_streams.h" \
  "io_throwable_streams.cpp" \
  "io_throwable_streams.h" \
  "impl/string_io.h" \
  "impl/string_io.cpp" \
  "dependencies.h" \
)

touch $GENERATED_FILE

# append copyright
cat $COPYRIGHT_TEXT_FILE > $GENERATED_FILE

printf "// Code is generated by scripts/move-basictl-cpp.sh.
// DO NOT EDIT!\n\n" >> $GENERATED_FILE

# append package
printf "package tlcodegen\n\n" >> $GENERATED_FILE

printf "func CppCopingStreamFiles() []string {\n" >> $GENERATED_FILE
printf "\tvalues := []string{" >> $GENERATED_FILE

for i in "${MOVING_FILES[@]}"
do
   printf "\n\t\t\"%s\"," $i >> $GENERATED_FILE
done

printf "\n\t}\n" >> $GENERATED_FILE
printf "\treturn values\n" >> $GENERATED_FILE
printf "}\n\n" >> $GENERATED_FILE

printf "func CppCopingStreamFilesText() map[string]string {\n" >> $GENERATED_FILE
printf "\tm := make(map[string]string)\n" >> $GENERATED_FILE

for i in "${MOVING_FILES[@]}"
do
   printf "\tm[\"%s\"] = \`" $i >> $GENERATED_FILE
   READING_FILE="$BASICTL_CPP_SOURCE/$i"
   cat $READING_FILE >> $GENERATED_FILE
   printf "\`\n" >> $GENERATED_FILE
done


printf "\treturn m\n" >> $GENERATED_FILE
printf "}\n" >> $GENERATED_FILE

diff="$(git diff)"
if [[ $diff ]]; then
    echo "There is some diff:"
    echo "$diff"
    exit 1
else
  echo "helpers_cpp_generated is synchronized with files in pkg/basictl_cpp"
fi
