// Copyright 2025 V Kontakte LLC
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

package puregen

import (
	"flag"
	"fmt"
	"io"
	"os"

	"github.com/vkcom/tl/internal/pure"
)

type Options struct {
	Language          string
	Outdir            string
	CopyrightFilePath string
	CopyrightText     string // set to content of CopyrightFilePath

	Verbose     bool
	ErrorWriter io.Writer // all Errors and warnings should be redirected to this io.Writer, by default it is os.Stderr

	SchemaURL       string
	SchemaTimestamp uint // for TLO version/date
	SchemaCommit    string

	// common options for many languages
	GenerateRPCCode    bool
	GenerateRandomCode bool
	BytesWhiteList     string

	GenerateTL2            bool // copy from Kernel, TODO - remove after kernel refactor
	GenerateLegacyJsonRead bool // always false, TODO - remove after kernel refactor

	Kernel pure.OptionsKernel
	Go     OptionsGo
}

func (opt *Options) Bind(f *flag.FlagSet) {
	f.StringVar(&opt.Language, "language", "",
		`generation target language (go, cpp, php). Empty for linter.`)
	f.StringVar(&opt.Outdir, "outdir", "",
		`where to write generated files`)
	f.StringVar(&opt.CopyrightFilePath, "copyrightPath", "",
		"path to file with copyright text")
	f.BoolVar(&opt.Verbose, "v", false,
		"verbose mode that prints debug info")

	f.StringVar(&opt.SchemaURL, "schemaURL", "",
		"url of schema (for documentation)")
	f.UintVar(&opt.SchemaTimestamp, "schemaTimestamp", 0,
		"timestamp of schema (for documentation, TLO version)")
	f.StringVar(&opt.SchemaCommit, "schemaCommit", "",
		"commit of schema (for documentation)")

	f.BoolVar(&opt.GenerateRPCCode, "generateRPCCode", false,
		"whether to generate *_server.go files")
	f.BoolVar(&opt.GenerateRandomCode, "generateRandomCode", false,
		"whether to generate methods for random filling structs")
	f.StringVar(&opt.BytesWhiteList, "generateByteVersions", "",
		"comma-separated list of fully-qualified top-level types or namespaces (if have trailing '.'), to generate byte versions for. Empty means none, '*' means all.")

	opt.Kernel.Bind(f)
	opt.Go.Bind(f)
}

func (opt *Options) Validate() error {
	opt.GenerateTL2 = opt.Kernel.GenerateTL2
	if !opt.GenerateTL2 {
		opt.Kernel.TL2WhiteList = "" // so if we do not generate TL2, all wantsTL flags are false
	}

	// historically, there were some defaults for different languages, we keep them for now
	switch opt.Language {
	case "cpp":
		opt.CopyrightText = "// Code generated by vktl/cmd/tlgen2; DO NOT EDIT.\n"
	case "php":
		opt.CopyrightText = `/**
 * AUTOGENERATED, DO NOT EDIT! If you want to modify it, check tl schema.
 *
 * This autogenerated code represents tl class for typed RPC API.
 */

`
	}
	if opt.CopyrightFilePath != "" {
		buf, err := os.ReadFile(opt.CopyrightFilePath)
		if err != nil {
			return fmt.Errorf("failed to open copyright text file %q: %w", opt.CopyrightFilePath, err)
		}
		opt.CopyrightText = string(buf)
	}
	return nil
}
