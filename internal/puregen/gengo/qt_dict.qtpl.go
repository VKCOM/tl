// Code generated by qtc from "qt_dict.qtpl". DO NOT EDIT.
// See https://github.com/valyala/quicktemplate for details.

package gengo

import (
	qtio422016 "io"

	qt422016 "github.com/valyala/quicktemplate"
)

var (
	_ = qtio422016.Copy
	_ = qt422016.AcquireByteBuffer
)

func (tuple *TypeRWDict) StreamGenerateCode(qw422016 *qt422016.Writer, bytesVersion bool, directImports *DirectImports) {
	goName := addBytes(tuple.wr.goGlobalName, bytesVersion)
	natDecl := formatNatArgsDecl(tuple.wr.NatParams)
	// natCall := formatNatArgsDeclCall(tuple.wr.NatParams)
	// tlTag := fmt.Sprintf("0x%08x", tuple.wr.tlTag)
	typeString := tuple.wr.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
	elementTypeString := tuple.element.t.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
	writeElementNeedsError := tuple.element.t.hasErrorInWriteMethods

	keyTypeString := tuple.dictKeyField.t.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
	valueTypeString := tuple.dictValueField.t.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
	valueNatArgsDecl := formatNatArgsDecl(tuple.element.t.NatParams)
	valueNatArgsCall := formatNatArgsDeclCall(tuple.element.t.NatParams)
	keyFieldName := tuple.dictKeyField.goName
	valueFieldName := tuple.dictValueField.goName

	if bytesVersion {
		if tuple.wr.gen.options.GenerateRandomCode {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`FillRandom(rg *basictl.RandGenerator, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) {
    rg.IncreaseDepth()
    l := basictl.RandomSize(rg)
    *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, l)
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeRandomCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", formatNatArgs(nil, tuple.element.NatArgs()), false))
			qw422016.N().S(`
    }
    rg.DecreaseDepth()
}

`)
		}
		if tuple.wr.hasRepairMasks {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`RepairMasks(vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) {
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeRepairMasksCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", formatNatArgs(nil, tuple.element.NatArgs()), false))
			qw422016.N().S(`
    }
}
`)
		}
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Read(w []byte, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
`)
		if tuple.wr.originateFromTL2 {
			qw422016.N().S(`    return w, basictl.TL2Error("not implemented for tl2 type")
`)
		} else {
			qw422016.N().S(`    var l uint32
    if w, err = basictl.NatRead(w, &l); err != nil {
        return w, err
    }
`)
			if tuple.wr.gen.options.Go.UseCheckLengthSanity {
				qw422016.N().S(`    if err = basictl.CheckLengthSanity(w, l, 4); err != nil {
        return w, err
    }
`)
			}
			qw422016.N().S(`    if uint32(cap(*vec)) < l {
        *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, l)
    } else {
        *vec = (*vec)[:l]
    }
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeReadingCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", tuple.element.Bare(), formatNatArgs(nil, tuple.element.NatArgs()), false, false))
			qw422016.N().S(`
    }
    return w, nil
`)
		}
		qw422016.N().S(`}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Write(w []byte, vec `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
`)
		if tuple.wr.originateFromTL2 {
			if writeElementNeedsError {
				qw422016.N().S(`    return w, basictl.TL2Error("not implemented for tl2 type")
`)
			} else {
				qw422016.N().S(`    return w
`)
			}
		} else {
			qw422016.N().S(`    w = basictl.NatWrite(w, uint32(len(vec)))
    for _, elem := range vec {
        `)
			qw422016.N().S(tuple.element.t.TypeWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.NatArgs()), false, false, writeElementNeedsError))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return w, nil
`)
			} else {
				qw422016.N().S(`    return w
`)
			}
		}
		qw422016.N().S(`}
`)
		if tuple.wr.gen.options.GenerateTL2() {
			qw422016.N().S(`
`)
			if tuple.wr.wantsTL2 {
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`CalculateLayout(sizes []int, optimizeEmpty bool, vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(`) ([]int, int) {
    if len(*vec) == 0 {
        if optimizeEmpty {
            return sizes, 0
        }
        return sizes, 1
    }
    sizePosition := len(sizes)
    sizes = append(sizes, 0)

    currentSize := 0
    var sz int

    currentSize += basictl.TL2CalculateSize(len(*vec))
    for i := 0; i < len(*vec); i++ {
        `)
				qw422016.N().S(tuple.element.t.CalculateLayoutCall(directImports, bytesVersion, "sizes", "(*vec)[i]", false, tuple.wr.ins, false))
				qw422016.N().S(`
    }
    sizes[sizePosition] = currentSize
    currentSize += basictl.TL2CalculateSize(currentSize)
    `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`Unused(sz)
    return sizes, currentSize
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`InternalWriteTL2(w []byte, sizes []int, optimizeEmpty bool,vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(`) ([]byte, []int, int) {
    if len(*vec) == 0 {
        if optimizeEmpty {
            return w, sizes, 0
        }
        w = append(w, 0)
        return w, sizes, 1
    }
    currentSize := sizes[0]
    sizes = sizes[1:]
    w = basictl.TL2WriteSize(w, currentSize)
    if currentSize == 0 {
        return w, sizes, 1
    }
    oldLen := len(w)
    w = basictl.TL2WriteSize(w, len(*vec))

    var sz int
    for i := 0; i < len(*vec); i++ {
        `)
				qw422016.N().S(tuple.element.t.WriteTL2Call(directImports, bytesVersion, "sizes", "w", "(*vec)[i]", false, tuple.wr.ins, false))
				qw422016.N().S(`
    }
    if len(w) - oldLen != currentSize {
        panic("tl2: mismatch between calculate and write")
    }
    `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`Unused(sz)
    return w, sizes, currentSize
}
`)
			}
			qw422016.N().S(`
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`InternalReadTL2(r []byte, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(`) (_ []byte, err error) {
`)
			if !tuple.wr.wantsTL2 {
				qw422016.N().S(`    return r, `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorTL2SerializersNotGenerated(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`)
`)
			} else {
				qw422016.N().S(`    currentSize := 0
    if r, currentSize, err = basictl.TL2ParseSize(r); err != nil { return r, err }
    if len(r) < currentSize {
        return r, basictl.TL2Error("not enough data: expected %d, got %d", currentSize, len(r))
    }

    currentR := r[:currentSize]
    r = r[currentSize:]

    elementCount := 0
    if currentSize != 0 {
        if currentR, elementCount, err = basictl.TL2ParseSize(currentR); err != nil { return r, err }
        if elementCount > len(currentR) {
            return r, basictl.TL2ElementCountError(elementCount, currentR)
        }
    }

    if cap(*vec) < elementCount {
        *vec = make([]`)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`, elementCount)
    }
    *vec = (*vec)[:elementCount]
    for i := 0; i < elementCount; i++ {
        elem := (*vec)[i]
        `)
				qw422016.N().S(tuple.element.t.ReadTL2Call(directImports, bytesVersion, "currentR", "elem", false, tuple.wr.ins, false))
				qw422016.N().S(`
    }
    return r, nil
`)
			}
			qw422016.N().S(`}
`)
		}
		qw422016.N().S(`
`)
		if tuple.dictKeyString {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadJSONGeneral(tctx *basictl.JSONReadContext, in *basictl.JsonLexer, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) error {
	*vec = (*vec)[:cap(*vec)]
	index := 0
	if in != nil {
        in.Delim('{')
        if !in.Ok() {
            return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected json object")
        }
        for ;!in.IsDelim('}'); index++ {
            if len(*vec) <= index {
                var newValue `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`
                *vec = append(*vec, newValue)
                *vec = (*vec)[:cap(*vec)]
            }
            (*vec)[index].Key = append((*vec)[index].Key[:0], in.UnsafeFieldName(true)...)
            in.WantColon()
            `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "(*vec)[index]."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.NatArgs()), false))
			qw422016.N().S(`
            in.WantComma()
        }
        in.Delim('}')
        if !in.Ok() {
            return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected json object's end")
        }
    }
	*vec = (*vec)[:index]
	return nil
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSON(w []byte, vec `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    tctx := basictl.JSONWriteContext{}
    return `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSONOpt(&tctx, w, vec`)
			qw422016.N().S(valueNatArgsCall)
			qw422016.N().S(`)
}
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSONOpt(tctx *basictl.JSONWriteContext, w []byte, vec `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    w = append(w, '{')
    for _, elem := range vec {
        w = basictl.JSONAddCommaIfNeeded(w)
        w = basictl.JSONWriteStringBytes(w, elem.`)
			qw422016.N().S(tuple.dictKeyField.goName)
			qw422016.N().S(`)
        w = append(w, ':')
        `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.NatArgs()), false, writeElementNeedsError))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return append(w, '}'), nil
`)
			} else {
				qw422016.N().S(`    return append(w, '}')
`)
			}
			qw422016.N().S(`}
`)
		} else {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadJSONGeneral(tctx *basictl.JSONReadContext, in *basictl.JsonLexer, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) error {
	*vec = (*vec)[:cap(*vec)]
	index := 0
	if in != nil {
        in.Delim('{')
        if !in.Ok() {
            return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected json object")
        }
        for ;!in.IsDelim('}'); index++ {
            if len(*vec) <= index {
                var newValue `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`
                *vec = append(*vec, newValue)
                *vec = (*vec)[:cap(*vec)]
            }
            keyBytes := []byte(in.UnsafeFieldName(false))
            if !in.Ok() {
                return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected correct json value in key")
            }
            in2 := basictl.JsonLexer{Data: keyBytes}
            `)
			qw422016.N().S(tuple.dictKeyField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "&in2", "(*vec)[index]."+keyFieldName, formatNatArgs(nil, tuple.dictKeyField.NatArgs()), false))
			qw422016.N().S(`
            in.WantColon()
            `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "(*vec)[index]."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.NatArgs()), false))
			qw422016.N().S(`
            in.WantComma()
        }
        in.Delim('}')
        if !in.Ok() {
            return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected json object's end")
        }
    }
	*vec = (*vec)[:index]
	return nil
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSON(w []byte, vec `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    tctx := basictl.JSONWriteContext{}
    return `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSONOpt(&tctx, w, vec`)
			qw422016.N().S(valueNatArgsCall)
			qw422016.N().S(`)
}
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSONOpt(tctx *basictl.JSONWriteContext, w []byte, vec `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    w = append(w, '{')
    for _, elem := range vec {
        key := elem.`)
			qw422016.N().S(keyFieldName)
			qw422016.N().S(`
        w = basictl.JSONAddCommaIfNeeded(w)
        w = append(w, `)
			qw422016.N().S("`")
			qw422016.N().S(`"`)
			qw422016.N().S("`")
			qw422016.N().S(`...)
        `)
			qw422016.N().S(tuple.dictKeyField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "key", formatNatArgs(nil, tuple.dictKeyField.NatArgs()), false, tuple.dictKeyField.t.hasErrorInWriteMethods))
			qw422016.N().S(`
        w = append(w, `)
			qw422016.N().S("`")
			qw422016.N().S(`":`)
			qw422016.N().S("`")
			qw422016.N().S(`...)
        `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.NatArgs()), false, tuple.dictValueField.t.hasErrorInWriteMethods))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return append(w, '}'), nil
`)
			} else {
				qw422016.N().S(`    return append(w, '}')
`)
			}
			qw422016.N().S(`}
`)
		}
	} else {
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Reset(m map[`)
		qw422016.N().S(keyTypeString)
		qw422016.N().S(`]`)
		qw422016.N().S(valueTypeString)
		qw422016.N().S(`) {
    clear(m)
}

`)
		if tuple.wr.gen.options.GenerateRandomCode {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`FillRandom(rg *basictl.RandGenerator, m *map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) {
    rg.IncreaseDepth()
    l := basictl.RandomSize(rg)
    *m = make(map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`, l)
    for i := 0; i < int(l); i++ {
        var elem `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`
        `)
			qw422016.N().S(tuple.element.t.TypeRandomCode(bytesVersion, directImports, tuple.wr.ins, "elem", formatNatArgs(nil, tuple.element.NatArgs()), false))
			qw422016.N().S(`
        (*m)[elem.`)
			qw422016.N().S(keyFieldName)
			qw422016.N().S(`] = elem.`)
			qw422016.N().S(valueFieldName)
			qw422016.N().S(`
    }
    rg.DecreaseDepth()
}
`)
		}
		if tuple.wr.hasRepairMasks {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`RepairMasks(m *map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) {
    for key, val := range *m {
        elem := `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`{`)
			qw422016.N().S(keyFieldName)
			qw422016.N().S(`:key, `)
			qw422016.N().S(valueFieldName)
			qw422016.N().S(`:val}
        `)
			qw422016.N().S(tuple.element.t.TypeRepairMasksCode(bytesVersion, directImports, tuple.wr.ins, "elem", formatNatArgs(nil, tuple.element.NatArgs()), false))
			qw422016.N().S(`
        (*m)[key] = elem.`)
			qw422016.N().S(valueFieldName)
			qw422016.N().S(`
    }
}
`)
		}
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Read(w []byte, m *map[`)
		qw422016.N().S(keyTypeString)
		qw422016.N().S(`]`)
		qw422016.N().S(valueTypeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
`)
		if tuple.wr.originateFromTL2 {
			qw422016.N().S(`    return w, basictl.TL2Error("not implemented for tl2 type")
`)
		} else {
			qw422016.N().S(`    var l uint32
    if w, err = basictl.NatRead(w, &l); err != nil {
        return w, err
    }
`)
			if tuple.wr.gen.options.Go.UseCheckLengthSanity {
				qw422016.N().S(`    if err = basictl.CheckLengthSanity(w, l, 4); err != nil {
        return w, err
    }
`)
			}
			qw422016.N().S(`    clear(*m)
    if l == 0 {
        return w, nil
    }
    if *m == nil {
        *m = make(map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`, l)
    }
    data := *m
    for i := 0; i < int(l); i++ {
        var elem `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`
        `)
			qw422016.N().S(tuple.element.t.TypeReadingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.NatArgs()), false, false))
			qw422016.N().S(`
         data[elem.`)
			qw422016.N().S(keyFieldName)
			qw422016.N().S(`] = elem.`)
			qw422016.N().S(valueFieldName)
			qw422016.N().S(`
    }
    return w, nil
`)
		}
		qw422016.N().S(`}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Write(w []byte, m map[`)
		qw422016.N().S(keyTypeString)
		qw422016.N().S(`]`)
		qw422016.N().S(valueTypeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
`)
		if tuple.wr.originateFromTL2 {
			if writeElementNeedsError {
				qw422016.N().S(`    return w, basictl.TL2Error("not implemented for tl2 type")
`)
			} else {
				qw422016.N().S(`    return w
`)
			}
		} else {
			qw422016.N().S(`    w = basictl.NatWrite(w, uint32(len(m)))
    if len(m) == 0 {
`)
			if writeElementNeedsError {
				qw422016.N().S(`        return w, nil
`)
			} else {
				qw422016.N().S(`        return w
`)
			}
			qw422016.N().S(`    }
    keys := make([]`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`, 0, len(m))
    for k := range m {
        keys = append(keys, k)
    }
`)
			directImports.importSort = true

			if tuple.dictKeyString {
				qw422016.N().S(`    sort.Strings(keys)
`)
			} else {
				qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
`)
			}
			qw422016.N().S(`    for _, key := range keys {
        val := m[key]
        elem := `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`{`)
			qw422016.N().S(keyFieldName)
			qw422016.N().S(`:key, `)
			qw422016.N().S(valueFieldName)
			qw422016.N().S(`:val}
        `)
			qw422016.N().S(tuple.element.t.TypeWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.NatArgs()), false, false, writeElementNeedsError))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return w, nil
`)
			} else {
				qw422016.N().S(`    return w
`)
			}
		}
		qw422016.N().S(`}
`)
		if tuple.wr.gen.options.GenerateTL2() {
			qw422016.N().S(`
`)
			if tuple.wr.wantsTL2 {
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`CalculateLayout(sizes []int, optimizeEmpty bool, m *map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`) ([]int, int) {
    if len(*m) == 0 {
        if optimizeEmpty {
            return sizes, 0
        }
        return sizes, 1
    }
    sizePosition := len(sizes)
    sizes = append(sizes, 0)

    currentSize := 0
    var sz int

    currentSize += basictl.TL2CalculateSize(len(*m))

`)
				/* final size does not depend on order, but contents of sizes does, InternalWriteTL2 must run in exact lockstep */

				qw422016.N().S(`    keys := make([]`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`, 0, len(*m))
    for k := range *m {
        keys = append(keys, k)
    }
`)
				if tuple.dictKeyString {
					qw422016.N().S(`    sort.Strings(keys)
`)
				} else {
					qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
`)
				}
				qw422016.N().S(`
    for _, key := range keys {
        elem := `)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`{`)
				qw422016.N().S(keyFieldName)
				qw422016.N().S(`:key, `)
				qw422016.N().S(valueFieldName)
				qw422016.N().S(`:(*m)[key]}
        `)
				qw422016.N().S(tuple.element.t.CalculateLayoutCall(directImports, bytesVersion, "sizes", "elem", false, tuple.wr.ins, false))
				qw422016.N().S(`
    }
    sizes[sizePosition] = currentSize
    currentSize += basictl.TL2CalculateSize(currentSize)
    `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`Unused(sz)
    return sizes, currentSize
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`InternalWriteTL2(w []byte, sizes []int, optimizeEmpty bool, m *map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`) ([]byte, []int, int) {
    if len(*m) == 0 {
        if optimizeEmpty {
            return w, sizes, 0
        }
        w = append(w, 0)
        return w, sizes, 1
    }
    currentSize := sizes[0]
    sizes = sizes[1:]
    w = basictl.TL2WriteSize(w, currentSize)
    if currentSize == 0 {
        return w, sizes, 1
    }
    oldLen := len(w)
    w = basictl.TL2WriteSize(w, len(*m))

    keys := make([]`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`, 0, len(*m))
    for k := range *m {
        keys = append(keys, k)
    }
`)
				if tuple.dictKeyString {
					qw422016.N().S(`    sort.Strings(keys)
`)
				} else {
					qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
`)
				}
				qw422016.N().S(`
    var sz int
    for _, key := range keys {
        elem := `)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`{`)
				qw422016.N().S(keyFieldName)
				qw422016.N().S(`:key, `)
				qw422016.N().S(valueFieldName)
				qw422016.N().S(`:(*m)[key]}
        `)
				qw422016.N().S(tuple.element.t.WriteTL2Call(directImports, bytesVersion, "sizes", "w", "elem", false, tuple.wr.ins, false))
				qw422016.N().S(`
    }
    if len(w) - oldLen != currentSize {
        panic("tl2: mismatch between calculate and write")
    }
    `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`Unused(sz)
    return w, sizes, currentSize
}
`)
			}
			qw422016.N().S(`
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`InternalReadTL2(r []byte, m *map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`) (_ []byte, err error) {
`)
			if !tuple.wr.wantsTL2 {
				qw422016.N().S(`    return r, `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorTL2SerializersNotGenerated(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`)
`)
			} else {
				qw422016.N().S(`    currentSize := 0
    if r, currentSize, err = basictl.TL2ParseSize(r); err != nil { return r, err }
    if len(r) < currentSize {
        return r, basictl.TL2Error("not enough data: expected %d, got %d", currentSize, len(r))
    }

    currentR := r[:currentSize]
    r = r[currentSize:]

    elementCount := 0
    if currentSize != 0 {
        if currentR, elementCount, err = basictl.TL2ParseSize(currentR); err != nil { return r, err }
        if elementCount > len(currentR) {
            return r, basictl.TL2ElementCountError(elementCount, currentR)
        }
    }

    clear(*m)
    if elementCount == 0 {
        return r, nil
    }
    if *m == nil {
        *m = make(map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`, elementCount)
    }
    data := *m

    for i := 0; i < elementCount; i++ {
        elem := `)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`{}
        `)
				qw422016.N().S(tuple.element.t.ReadTL2Call(directImports, bytesVersion, "currentR", "elem", false, tuple.wr.ins, false))
				qw422016.N().S(`
        data[elem.`)
				qw422016.N().S(keyFieldName)
				qw422016.N().S(`] = elem.`)
				qw422016.N().S(valueFieldName)
				qw422016.N().S(`
    }
    return r, nil
`)
			}
			qw422016.N().S(`}
`)
		}
		qw422016.N().S(`
func `)
		qw422016.N().S(goName)
		qw422016.N().S(`ReadJSONGeneral(tctx *basictl.JSONReadContext, in *basictl.JsonLexer, m *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(valueNatArgsDecl)
		qw422016.N().S(`) error {
    clear(*m)
	if *m == nil {
	    *m = make(map[`)
		qw422016.N().S(keyTypeString)
		qw422016.N().S(`]`)
		qw422016.N().S(valueTypeString)
		qw422016.N().S(`, 0)
	}
    data := *m

    if in != nil {
        in.Delim('{')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json object")
        }
        for !in.IsDelim('}') {
`)
		if tuple.dictKeyString {
			qw422016.N().S(`            key := in.UnsafeFieldName(true)
            in.WantColon()
            var value `)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`
            `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "value", formatNatArgs(nil, tuple.dictValueField.NatArgs()), false))
			qw422016.N().S(`
            data[key] = value
`)
		} else {
			qw422016.N().S(`            keyBytes := []byte(in.UnsafeFieldName(false))
            in.WantColon()
            if !in.Ok() {
                return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected correct json value in key")
            }
            in2 := basictl.JsonLexer{Data: keyBytes}
            var key `)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`
            `)
			qw422016.N().S(tuple.dictKeyField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "&in2", "key", formatNatArgs(nil, tuple.dictKeyField.NatArgs()), false))
			qw422016.N().S(`
            var value `)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`
            `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "value", formatNatArgs(nil, tuple.dictValueField.NatArgs()), false))
			qw422016.N().S(`
            data[key] = value
`)
		}
		qw422016.N().S(`            in.WantComma()
        }
        in.Delim('}')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json object's end")
        }
    }
    return nil
}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSON(w []byte, m `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(valueNatArgsDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
    tctx := basictl.JSONWriteContext{}
    return `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSONOpt(&tctx, w, m`)
		qw422016.N().S(valueNatArgsCall)
		qw422016.N().S(`)
}
`)
		if tuple.dictKeyString {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSONOpt(tctx *basictl.JSONWriteContext, w []byte, m `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    keys := make([]`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`, 0, len(m))
    for k := range m {
        keys = append(keys, k)
    }
`)
			directImports.importSort = true

			qw422016.N().S(`    sort.Strings(keys)
    w = append(w, '{')
    for _, key := range keys {
        value := m[key]
        w = basictl.JSONAddCommaIfNeeded(w)
        w = basictl.JSONWriteString(w, key)
        w = append(w, ':')
        `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "value", formatNatArgs(nil, tuple.dictValueField.NatArgs()), false, tuple.dictValueField.t.hasErrorInWriteMethods))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return append(w, '}'), nil
`)
			} else {
				qw422016.N().S(`    return append(w, '}')
`)
			}
			qw422016.N().S(`}
`)
		} else {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSONOpt(tctx *basictl.JSONWriteContext, w []byte, m `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    keys := make([]`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`, 0, len(m))
    for k := range m {
        keys = append(keys, k)
    }
`)
			directImports.importSort = true

			qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
    w = append(w, '{')
    for _, key := range keys {
        value := m[key]
        w = basictl.JSONAddCommaIfNeeded(w)
        w = append(w, `)
			qw422016.N().S("`")
			qw422016.N().S(`"`)
			qw422016.N().S("`")
			qw422016.N().S(`...)
        `)
			qw422016.N().S(tuple.dictKeyField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "key", formatNatArgs(nil, tuple.dictKeyField.NatArgs()), false, tuple.dictKeyField.t.hasErrorInWriteMethods))
			qw422016.N().S(`
        w = append(w, `)
			qw422016.N().S("`")
			qw422016.N().S(`":`)
			qw422016.N().S("`")
			qw422016.N().S(`...)
        `)
			qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "value", formatNatArgs(nil, tuple.dictValueField.NatArgs()), false, tuple.dictValueField.t.hasErrorInWriteMethods))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return append(w, '}'), nil
`)
			} else {
				qw422016.N().S(`    return append(w, '}')
`)
			}
			qw422016.N().S(`}
`)
		}
	}
}

func (tuple *TypeRWDict) WriteGenerateCode(qq422016 qtio422016.Writer, bytesVersion bool, directImports *DirectImports) {
	qw422016 := qt422016.AcquireWriter(qq422016)
	tuple.StreamGenerateCode(qw422016, bytesVersion, directImports)
	qt422016.ReleaseWriter(qw422016)
}

func (tuple *TypeRWDict) GenerateCode(bytesVersion bool, directImports *DirectImports) string {
	qb422016 := qt422016.AcquireByteBuffer()
	tuple.WriteGenerateCode(qb422016, bytesVersion, directImports)
	qs422016 := string(qb422016.B)
	qt422016.ReleaseByteBuffer(qb422016)
	return qs422016
}
