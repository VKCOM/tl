// Code generated by qtc from "qt_brackets.qtpl". DO NOT EDIT.
// See https://github.com/valyala/quicktemplate for details.

package tlcodegen

import (
	qtio422016 "io"

	qt422016 "github.com/valyala/quicktemplate"
)

var (
	_ = qtio422016.Copy
	_ = qt422016.AcquireByteBuffer
)

func (tuple *TypeRWBrackets) StreamGenerateCode(qw422016 *qt422016.Writer, bytesVersion bool, directImports *DirectImports) {
	goName := addBytes(tuple.wr.goGlobalName, bytesVersion)
	natDecl := formatNatArgsDecl(tuple.wr.NatParams)
	natCall := formatNatArgsDeclCall(tuple.wr.NatParams)
	typeString := tuple.wr.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
	elementTypeString := tuple.element.t.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
	writeElementNeedsError := tuple.element.t.hasErrorInWriteMethods

	switch {
	case tuple.dictLike:
		keyTypeString := tuple.dictKeyField.t.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
		valueTypeString := tuple.dictValueField.t.TypeString2(bytesVersion, directImports, tuple.wr.ins, false, false)
		valueNatArgsDecl := formatNatArgsDecl(tuple.element.t.NatParams)
		valueNatArgsCall := formatNatArgsDeclCall(tuple.element.t.NatParams)
		keyFieldName := tuple.dictKeyField.goName
		valueFieldName := tuple.dictValueField.goName

		if bytesVersion {
			if tuple.wr.gen.options.GenerateRandomCode {
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`FillRandom(rg *basictl.RandGenerator, vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(natDecl)
				qw422016.N().S(`) {
    rg.IncreaseDepth()
    l := rg.LimitValue(basictl.RandomUint(rg))
    *vec = make([]`)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`, l)
    for i := range *vec {
        `)
				qw422016.N().S(tuple.element.t.TypeRandomCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", formatNatArgs(nil, tuple.element.natArgs), false))
				qw422016.N().S(`
    }
    rg.DecreaseDepth()
}
`)
			}
			qw422016.N().S(`
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`Read(w []byte, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) (_ []byte, err error) {
    var l uint32
    if w, err = basictl.NatRead(w, &l); err != nil {
        return w, err
    }
`)
			if tuple.wr.gen.options.UseCheckLengthSanity {
				qw422016.N().S(`    if err = basictl.CheckLengthSanity(w, l, 4); err != nil {
        return w, err
    }
`)
			}
			qw422016.N().S(`    if uint32(cap(*vec)) < l {
        *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, l)
    } else {
        *vec = (*vec)[:l]
    }
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeReadingCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false))
			qw422016.N().S(`
    }
    return w, nil
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`Write(w []byte, vec `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    w = basictl.NatWrite(w, uint32(len(vec)))
    for _, elem := range vec {
        `)
			qw422016.N().S(tuple.element.t.TypeWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false, writeElementNeedsError))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return w, nil
`)
			} else {
				qw422016.N().S(`    return w
`)
			}
			qw422016.N().S(`}
`)
			if tuple.wr.gen.options.GenerateTL2 {
				qw422016.N().S(`
func `)
				qw422016.N().S(goName)
				qw422016.N().S(`CalculateLayout(sizes []int,vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) []int {
    sizePosition := len(sizes)
    sizes = append(sizes, 0)
    for i := 0; i < len(*vec); i++ {
`)
				_, trivialSizeKey := tuple.dictKeyField.t.trw.tl2TrivialSize("(*vec)[i].Key", false, tuple.dictKeyField.recursive)
				sizeValueKey := trivialSizeKey
				if len(trivialSizeKey) == 0 {
					sizeValueKey = "sizes[currentPosition]"
				}
				_, trivialSizeValue := tuple.dictValueField.t.trw.tl2TrivialSize("(*vec)[i].Value", false, tuple.dictValueField.recursive)
				sizeValueValue := trivialSizeValue
				if len(trivialSizeValue) == 0 {
					sizeValueKey = "sizes[currentPosition]"
				}

				if len(trivialSizeKey) == 0 {
					qw422016.N().S(`        currentPosition := len(sizes)
`)
				}
				qw422016.N().S(`        `)
				qw422016.N().S(tuple.dictKeyField.t.CalculateLayout(bytesVersion, "sizes", "(*vec)[i].Key", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        sizes[sizePosition] += `)
				qw422016.N().S(sizeValueKey)
				qw422016.N().S(`
`)
				if tuple.dictKeyField.t.trw.isSizeWrittenInData() {
					qw422016.N().S(`        sizes[sizePosition] += basictl.TL2CalculateSize(`)
					qw422016.N().S(sizeValueKey)
					qw422016.N().S(`)
`)
				}
				if len(trivialSizeValue) == 0 && len(trivialSizeKey) == 0 {
					qw422016.N().S(`        currentPosition = len(sizes)
`)
				} else if len(trivialSizeValue) == 0 {
					qw422016.N().S(`        currentPosition := len(sizes)
`)
				}
				qw422016.N().S(`        `)
				qw422016.N().S(tuple.dictValueField.t.CalculateLayout(bytesVersion, "sizes", "(*vec)[i].Value", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        sizes[sizePosition] += `)
				qw422016.N().S(sizeValueValue)
				qw422016.N().S(`
`)
				if tuple.dictValueField.t.trw.isSizeWrittenInData() {
					qw422016.N().S(`        sizes[sizePosition] += basictl.TL2CalculateSize(`)
					qw422016.N().S(sizeValueValue)
					qw422016.N().S(`)
`)
				}
				qw422016.N().S(`    }
    return sizes
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`InternalWriteTL2(w []byte, sizes []int,vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) ([]byte, []int) {
    currentSize := sizes[0]
    sizes = sizes[1:]

    w = basictl.TL2WriteSize(w, currentSize)
    if currentSize == 0 {
        return w, sizes
    }

    for i := 0; i < len(*vec); i++ {
`)
				if tuple.dictKeyField.t.trw.doesWriteTL2UseObject(false) || tuple.dictValueField.t.trw.doesWriteTL2UseObject(false) {
					qw422016.N().S(`        elem := (*vec)[i]
`)
				}
				qw422016.N().S(`        `)
				qw422016.N().S(tuple.dictKeyField.t.WriteTL2Call(bytesVersion, "sizes", "w", "elem.Key", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        `)
				qw422016.N().S(tuple.dictValueField.t.WriteTL2Call(bytesVersion, "sizes", "w", "elem.Value", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
    }
    return w, sizes
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`ReadTL2(r []byte, vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) (_ []byte, err error) {
    saveR := r
    currentSize := 0
    if r, currentSize, err = basictl.TL2ParseSize(r); err != nil { return r, err }
    shift := currentSize + basictl.TL2CalculateSize(currentSize)

    *vec = (*vec)[:0]
    for len(saveR) < len(r) + shift {
        var elem `)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`
        `)
				qw422016.N().S(tuple.dictKeyField.t.ReadTL2Call(bytesVersion, "r", "elem.Key", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        `)
				qw422016.N().S(tuple.dictValueField.t.ReadTL2Call(bytesVersion, "r", "elem.Value", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        *vec = append(*vec, elem)
    }
    return r, nil
}
`)
			}
			qw422016.N().S(`
`)
			if tuple.dictKeyString {
				if tuple.wr.gen.options.GenerateLegacyJsonRead {
					qw422016.N().S(`func `)
					qw422016.N().S(goName)
					qw422016.N().S(`ReadJSONLegacy(legacyTypeNames bool, j interface{}, vec *`)
					qw422016.N().S(typeString)
					qw422016.N().S(` `)
					qw422016.N().S(valueNatArgsDecl)
					qw422016.N().S(`) error {
    var _map map[string]interface{}
    var _mapok bool
    if j != nil {
        _map, _mapok = j.(map[string]interface{})
        if !_mapok {
            return `)
					qw422016.N().S(tuple.wr.gen.InternalPrefix())
					qw422016.N().S(`ErrorInvalidJSON(`)
					qw422016.N().Q(typeString)
					qw422016.N().S(`, "expected json object")
        }
    }
      l := len(_map)
    if cap(*vec) < l {
        *vec = make([]`)
					qw422016.N().S(elementTypeString)
					qw422016.N().S(`, l)
    } else {
        *vec = (*vec)[:l]
    }
    i := 0
    arr := *vec
    for key, _jvalue := range _map {
        arr[i].`)
					qw422016.N().S(tuple.dictKeyField.goName)
					qw422016.N().S(` = append(arr[i].`)
					qw422016.N().S(tuple.dictKeyField.goName)
					qw422016.N().S(`[:0], key...)
        `)
					qw422016.N().S(tuple.dictValueField.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_jvalue", "arr[i]."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.natArgs), false))
					qw422016.N().S(`
        i++
    }
    return nil
}

`)
				}
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`ReadJSON(legacyTypeNames bool, in *basictl.JsonLexer, vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) error {
	*vec = (*vec)[:cap(*vec)]
	index := 0
	if in != nil {
        in.Delim('{')
        if !in.Ok() {
            return `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorInvalidJSON(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`, "expected json object")
        }
        for ;!in.IsDelim('}'); index++ {
            if len(*vec) <= index {
                var newValue `)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`
                *vec = append(*vec, newValue)
                *vec = (*vec)[:cap(*vec)]
            }
            (*vec)[index].Key = append((*vec)[index].Key[:0], in.UnsafeFieldName(true)...)
            in.WantColon()
            `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "(*vec)[index]."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.natArgs), false))
				qw422016.N().S(`
            in.WantComma()
        }
        in.Delim('}')
        if !in.Ok() {
            return `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorInvalidJSON(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`, "expected json object's end")
        }
    }
	*vec = (*vec)[:index]
	return nil
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSON(w []byte, vec `)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) `)
				qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
				qw422016.N().S(` {
    return `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSONOpt(true, false, w, vec`)
				qw422016.N().S(valueNatArgsCall)
				qw422016.N().S(`)
}
func `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSONOpt(newTypeNames bool, short bool, w []byte, vec `)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) `)
				qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
				qw422016.N().S(` {
    w = append(w, '{')
    for _, elem := range vec {
        w = basictl.JSONAddCommaIfNeeded(w)
        w = basictl.JSONWriteStringBytes(w, elem.`)
				qw422016.N().S(tuple.dictKeyField.goName)
				qw422016.N().S(`)
        w = append(w, ':')
        `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.natArgs), false, writeElementNeedsError))
				qw422016.N().S(`
    }
`)
				if writeElementNeedsError {
					qw422016.N().S(`    return append(w, '}'), nil
`)
				} else {
					qw422016.N().S(`    return append(w, '}')
`)
				}
				qw422016.N().S(`}
`)
			} else {
				if tuple.wr.gen.options.GenerateLegacyJsonRead {
					qw422016.N().S(`func `)
					qw422016.N().S(goName)
					qw422016.N().S(`ReadJSONLegacy(legacyTypeNames bool, j interface{}, vec *`)
					qw422016.N().S(typeString)
					qw422016.N().S(` `)
					qw422016.N().S(valueNatArgsDecl)
					qw422016.N().S(`) error {
    var _map map[string]interface{}
    var _mapok bool
    if j != nil {
        _map, _mapok = j.(map[string]interface{})
        if !_mapok {
            return `)
					qw422016.N().S(tuple.wr.gen.InternalPrefix())
					qw422016.N().S(`ErrorInvalidJSON(`)
					qw422016.N().Q(typeString)
					qw422016.N().S(`, "expected json object")
        }
    }
      l := len(_map)
    if cap(*vec) < l {
        *vec = make([]`)
					qw422016.N().S(elementTypeString)
					qw422016.N().S(`, l)
    } else {
        *vec = (*vec)[:l]
    }
    i := 0
    arr := *vec
    for _jkey, _jvalue := range _map {
        `)
					qw422016.N().S(tuple.dictKeyField.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_jkey", "arr[i]."+keyFieldName, formatNatArgs(nil, tuple.dictKeyField.natArgs), false))
					qw422016.N().S(`
        `)
					qw422016.N().S(tuple.dictValueField.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_jvalue", "arr[i]."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.natArgs), false))
					qw422016.N().S(`
        i++
    }
    return nil
}

`)
				}
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`ReadJSON(legacyTypeNames bool, in *basictl.JsonLexer, vec *`)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) error {
	*vec = (*vec)[:cap(*vec)]
	index := 0
	if in != nil {
        in.Delim('{')
        if !in.Ok() {
            return `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorInvalidJSON(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`, "expected json object")
        }
        for ;!in.IsDelim('}'); index++ {
            if len(*vec) <= index {
                var newValue `)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`
                *vec = append(*vec, newValue)
                *vec = (*vec)[:cap(*vec)]
            }
            keyBytes := []byte(in.UnsafeFieldName(false))
            if !in.Ok() {
                return `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorInvalidJSON(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`, "expected correct json value in key")
            }
            in2 := basictl.JsonLexer{Data: keyBytes}
            `)
				qw422016.N().S(tuple.dictKeyField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "&in2", "(*vec)[index]."+keyFieldName, formatNatArgs(nil, tuple.dictKeyField.natArgs), false))
				qw422016.N().S(`
            in.WantColon()
            `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "(*vec)[index]."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.natArgs), false))
				qw422016.N().S(`
            in.WantComma()
        }
        in.Delim('}')
        if !in.Ok() {
            return `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorInvalidJSON(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`, "expected json object's end")
        }
    }
	*vec = (*vec)[:index]
	return nil
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSON(w []byte, vec `)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) `)
				qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
				qw422016.N().S(` {
    return `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSONOpt(true, false, w, vec`)
				qw422016.N().S(valueNatArgsCall)
				qw422016.N().S(`)
}
func `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSONOpt(newTypeNames bool, short bool, w []byte, vec `)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) `)
				qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
				qw422016.N().S(` {
    w = append(w, '{')
    for _, elem := range vec {
        key := elem.`)
				qw422016.N().S(keyFieldName)
				qw422016.N().S(`
        w = basictl.JSONAddCommaIfNeeded(w)
        w = append(w, `)
				qw422016.N().S("`")
				qw422016.N().S(`"`)
				qw422016.N().S("`")
				qw422016.N().S(`...)
        `)
				qw422016.N().S(tuple.dictKeyField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "key", formatNatArgs(nil, tuple.dictKeyField.natArgs), false, tuple.dictKeyField.t.hasErrorInWriteMethods))
				qw422016.N().S(`
        w = append(w, `)
				qw422016.N().S("`")
				qw422016.N().S(`":`)
				qw422016.N().S("`")
				qw422016.N().S(`...)
        `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem."+valueFieldName, formatNatArgs(nil, tuple.dictValueField.natArgs), false, tuple.dictValueField.t.hasErrorInWriteMethods))
				qw422016.N().S(`
    }
`)
				if writeElementNeedsError {
					qw422016.N().S(`    return append(w, '}'), nil
`)
				} else {
					qw422016.N().S(`    return append(w, '}')
`)
				}
				qw422016.N().S(`}
`)
			}
		} else {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`Reset(m map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`) {
    for k := range m {
        delete(m, k)
    }
}

`)
			if tuple.wr.gen.options.GenerateRandomCode {
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`FillRandom(rg *basictl.RandGenerator, m *map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(` `)
				qw422016.N().S(natDecl)
				qw422016.N().S(`) {
    rg.IncreaseDepth()
    l := rg.LimitValue(basictl.RandomUint(rg))
    *m = make(map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`, l)
    for i := 0; i < int(l); i++ {
        var elem `)
				qw422016.N().S(elementTypeString)
				qw422016.N().S(`
        `)
				qw422016.N().S(tuple.element.t.TypeRandomCode(bytesVersion, directImports, tuple.wr.ins, "elem", formatNatArgs(nil, tuple.element.natArgs), false))
				qw422016.N().S(`
        (*m)[elem.`)
				qw422016.N().S(keyFieldName)
				qw422016.N().S(`] = elem.`)
				qw422016.N().S(valueFieldName)
				qw422016.N().S(`
    }
    rg.DecreaseDepth()
}
`)
			}
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`Read(w []byte, m *map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) (_ []byte, err error) {
    var l uint32
    if w, err = basictl.NatRead(w, &l); err != nil {
        return w, err
    }
`)
			if tuple.wr.gen.options.UseCheckLengthSanity {
				qw422016.N().S(`    if err = basictl.CheckLengthSanity(w, l, 4); err != nil {
        return w, err
    }
`)
			}
			qw422016.N().S(`    var data map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`
    if *m == nil {
        if l == 0 {
            return w, nil
        }
        data = make(map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`, l)
        *m = data
    } else {
        data = *m
        for k := range data {
            delete(data, k)
        }
    }
    for i := 0; i < int(l); i++ {
        var elem `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`
        `)
			qw422016.N().S(tuple.element.t.TypeReadingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false))
			qw422016.N().S(`
         data[elem.`)
			qw422016.N().S(keyFieldName)
			qw422016.N().S(`] = elem.`)
			qw422016.N().S(valueFieldName)
			qw422016.N().S(`
    }
    return w, nil
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`Write(w []byte, m map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    w = basictl.NatWrite(w, uint32(len(m)))
    if len(m) == 0 {
`)
			if writeElementNeedsError {
				qw422016.N().S(`        return w, nil
`)
			} else {
				qw422016.N().S(`        return w
`)
			}
			qw422016.N().S(`    }
    keys := make([]`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`, 0, len(m))
    for k := range m {
        keys = append(keys, k)
    }
`)
			directImports.importSort = true

			if tuple.dictKeyString {
				qw422016.N().S(`    sort.Strings(keys)
`)
			} else {
				qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
`)
			}
			qw422016.N().S(`    for _, key := range keys {
        val := m[key]
        elem := `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`{`)
			qw422016.N().S(keyFieldName)
			qw422016.N().S(`:key, `)
			qw422016.N().S(valueFieldName)
			qw422016.N().S(`:val}
        `)
			qw422016.N().S(tuple.element.t.TypeWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false, writeElementNeedsError))
			qw422016.N().S(`
    }
`)
			if writeElementNeedsError {
				qw422016.N().S(`    return w, nil
`)
			} else {
				qw422016.N().S(`    return w
`)
			}
			qw422016.N().S(`}
`)
			if tuple.wr.gen.options.GenerateTL2 {
				qw422016.N().S(`
func `)
				qw422016.N().S(goName)
				qw422016.N().S(`CalculateLayout(sizes []int, m *map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(natDecl)
				qw422016.N().S(`) []int {
    sizePosition := len(sizes)
    sizes = append(sizes, 0)

    keys := make([]`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`, 0, len(*m))
    for k := range *m {
        keys = append(keys, k)
    }
`)
				if tuple.dictKeyString {
					qw422016.N().S(`    sort.Strings(keys)
`)
				} else {
					qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
`)
				}
				qw422016.N().S(`
    for i := 0; i < len(keys); i++ {
`)
				isConstantSizeKey, trivialSizeKey := tuple.dictKeyField.t.trw.tl2TrivialSize("key", false, tuple.dictKeyField.recursive)
				sizeValueKey := trivialSizeKey
				if len(trivialSizeKey) == 0 {
					sizeValueKey = "sizes[currentPosition]"
				}
				isConstantSizeValue, trivialSizeValue := tuple.dictValueField.t.trw.tl2TrivialSize("value", false, tuple.dictValueField.recursive)
				sizeValueValue := trivialSizeValue
				if len(trivialSizeValue) == 0 {
					sizeValueValue = "sizes[currentPosition]"
				}

				if (len(trivialSizeKey) == 0 || !isConstantSizeKey) || (len(trivialSizeValue) == 0 || !isConstantSizeValue) {
					qw422016.N().S(`        key := keys[i]
`)
				}
				if len(trivialSizeKey) == 0 {
					qw422016.N().S(`        currentPosition := len(sizes)
`)
				}
				qw422016.N().S(`        `)
				qw422016.N().S(tuple.dictKeyField.t.CalculateLayout(bytesVersion, "sizes", "key", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        sizes[sizePosition] += `)
				qw422016.N().S(sizeValueKey)
				qw422016.N().S(`
`)
				if tuple.dictKeyField.t.trw.isSizeWrittenInData() {
					qw422016.N().S(`        sizes[sizePosition] += basictl.TL2CalculateSize(`)
					qw422016.N().S(sizeValueKey)
					qw422016.N().S(`)
`)
				}
				if len(trivialSizeValue) == 0 || !isConstantSizeValue {
					qw422016.N().S(`        value := (*m)[key]
`)
				}
				if len(trivialSizeValue) == 0 && len(trivialSizeKey) == 0 {
					qw422016.N().S(`        currentPosition = len(sizes)
`)
				} else if len(trivialSizeValue) == 0 {
					qw422016.N().S(`        currentPosition := len(sizes)
`)
				}
				qw422016.N().S(`        `)
				qw422016.N().S(tuple.dictValueField.t.CalculateLayout(bytesVersion, "sizes", "value", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        sizes[sizePosition] += `)
				qw422016.N().S(sizeValueValue)
				qw422016.N().S(`
`)
				if tuple.dictValueField.t.trw.isSizeWrittenInData() {
					qw422016.N().S(`        sizes[sizePosition] += basictl.TL2CalculateSize(`)
					qw422016.N().S(sizeValueValue)
					qw422016.N().S(`)
`)
				}
				qw422016.N().S(`    }
    return sizes
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`InternalWriteTL2(w []byte, sizes []int, m *map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(natDecl)
				qw422016.N().S(`) ([]byte, []int) {
    currentSize := sizes[0]
    sizes = sizes[1:]

    w = basictl.TL2WriteSize(w, currentSize)
    if currentSize == 0 {
        return w, sizes
    }

    keys := make([]`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`, 0, len(*m))
    for k := range *m {
        keys = append(keys, k)
    }
`)
				if tuple.dictKeyString {
					qw422016.N().S(`    sort.Strings(keys)
`)
				} else {
					qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
`)
				}
				qw422016.N().S(`
    for i := 0; i < len(keys); i++ {
`)
				if tuple.dictKeyField.t.trw.doesWriteTL2UseObject(false) || tuple.dictValueField.t.trw.doesWriteTL2UseObject(false) {
					qw422016.N().S(`        key := keys[i]
`)
				}
				qw422016.N().S(`        `)
				qw422016.N().S(tuple.dictKeyField.t.WriteTL2Call(bytesVersion, "sizes", "w", "key", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
`)
				if tuple.dictValueField.t.trw.doesWriteTL2UseObject(false) {
					qw422016.N().S(`        value := (*m)[key]
`)
				}
				qw422016.N().S(`        `)
				qw422016.N().S(tuple.dictValueField.t.WriteTL2Call(bytesVersion, "sizes", "w", "value", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
    }

    return w, sizes
}

func `)
				qw422016.N().S(goName)
				qw422016.N().S(`ReadTL2(r []byte, m *map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(natDecl)
				qw422016.N().S(`) (_ []byte, err error) {
    saveR := r
    currentSize := 0
    if r, currentSize, err = basictl.TL2ParseSize(r); err != nil { return r, err }
    shift := currentSize + basictl.TL2CalculateSize(currentSize)

    if *m == nil {
        *m = make(map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`)
    }

    for key := range *m {
        delete(*m, key)
    }

    data := *m

    for len(saveR) < len(r) + shift {
        var key `)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`
        var value `)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`
        `)
				qw422016.N().S(tuple.dictKeyField.t.ReadTL2Call(bytesVersion, "r", "key", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        `)
				qw422016.N().S(tuple.dictValueField.t.ReadTL2Call(bytesVersion, "r", "value", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
				qw422016.N().S(`
        data[key] = value
    }
    return r, nil
}
`)
			}
			qw422016.N().S(`
`)
			if tuple.wr.gen.options.GenerateLegacyJsonRead {
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`ReadJSONLegacy(legacyTypeNames bool, j interface{}, m *`)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) error {
    var _map map[string]interface{}
    var _mapok bool
    if j != nil {
        _map, _mapok = j.(map[string]interface{})
        if !_mapok {
            return `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorInvalidJSON(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`, "expected json object")
        }
    }
    l := len(_map)
    var data map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`
    if *m == nil {
        if l == 0 {
            return nil
        }
        data = make(map[`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`]`)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`, l)
        *m = data
    } else {
        data = *m
        for k := range data {
            delete(data, k)
        }
    }
    for _jkey, _jvalue := range _map {
`)
				if tuple.dictKeyString {
				} else {
					qw422016.N().S(`        var key `)
					qw422016.N().S(keyTypeString)
					qw422016.N().S(`
        `)
					qw422016.N().S(tuple.dictKeyField.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_jkey", "key", formatNatArgs(nil, tuple.dictKeyField.natArgs), false))
					qw422016.N().S(`
`)
				}
				qw422016.N().S(`        var value `)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`
        `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_jvalue", "value", formatNatArgs(nil, tuple.dictValueField.natArgs), false))
				qw422016.N().S(`
`)
				if tuple.dictKeyString {
					qw422016.N().S(`        data[_jkey] = value
`)
				} else {
					qw422016.N().S(`        data[key] = value
`)
				}
				qw422016.N().S(`    }
    return nil
}

`)
			}
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadJSON(legacyTypeNames bool, in *basictl.JsonLexer, m *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) error {
	var data map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`
	if *m == nil {
	    *m = make(map[`)
			qw422016.N().S(keyTypeString)
			qw422016.N().S(`]`)
			qw422016.N().S(valueTypeString)
			qw422016.N().S(`, 0)
	    data = *m
	} else {
        data = *m
        for k := range data {
            delete(data, k)
        }
    }
    if in != nil {
        in.Delim('{')
        if !in.Ok() {
            return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected json object")
        }
        for !in.IsDelim('}') {
`)
			if tuple.dictKeyString {
				qw422016.N().S(`            key := in.UnsafeFieldName(true)
            in.WantColon()
            var value `)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`
            `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "value", formatNatArgs(nil, tuple.dictValueField.natArgs), false))
				qw422016.N().S(`
            data[key] = value
`)
			} else {
				qw422016.N().S(`            keyBytes := []byte(in.UnsafeFieldName(false))
            in.WantColon()
            if !in.Ok() {
                return `)
				qw422016.N().S(tuple.wr.gen.InternalPrefix())
				qw422016.N().S(`ErrorInvalidJSON(`)
				qw422016.N().Q(typeString)
				qw422016.N().S(`, "expected correct json value in key")
            }
            in2 := basictl.JsonLexer{Data: keyBytes}
            var key `)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`
            `)
				qw422016.N().S(tuple.dictKeyField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "&in2", "key", formatNatArgs(nil, tuple.dictKeyField.natArgs), false))
				qw422016.N().S(`
            var value `)
				qw422016.N().S(valueTypeString)
				qw422016.N().S(`
            `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "value", formatNatArgs(nil, tuple.dictValueField.natArgs), false))
				qw422016.N().S(`
            data[key] = value
`)
			}
			qw422016.N().S(`            in.WantComma()
        }
        in.Delim('}')
        if !in.Ok() {
            return `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`ErrorInvalidJSON(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, "expected json object's end")
        }
    }
    return nil
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSON(w []byte, m `)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(valueNatArgsDecl)
			qw422016.N().S(`) `)
			qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
			qw422016.N().S(` {
    return `)
			qw422016.N().S(goName)
			qw422016.N().S(`WriteJSONOpt(true, false, w, m`)
			qw422016.N().S(valueNatArgsCall)
			qw422016.N().S(`)
}
`)
			if tuple.dictKeyString {
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSONOpt(newTypeNames bool, short bool, w []byte, m `)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(valueNatArgsDecl)
				qw422016.N().S(`) `)
				qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
				qw422016.N().S(` {
    keys := make([]`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`, 0, len(m))
    for k := range m {
        keys = append(keys, k)
    }
`)
				directImports.importSort = true

				qw422016.N().S(`    sort.Strings(keys)
    w = append(w, '{')
    for _, key := range keys {
        value := m[key]
        w = basictl.JSONAddCommaIfNeeded(w)
        w = basictl.JSONWriteString(w, key)
        w = append(w, ':')
        `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "value", formatNatArgs(nil, tuple.dictValueField.natArgs), false, tuple.dictValueField.t.hasErrorInWriteMethods))
				qw422016.N().S(`
    }
`)
				if writeElementNeedsError {
					qw422016.N().S(`    return append(w, '}'), nil
`)
				} else {
					qw422016.N().S(`    return append(w, '}')
`)
				}
				qw422016.N().S(`}
`)
			} else {
				qw422016.N().S(`func `)
				qw422016.N().S(goName)
				qw422016.N().S(`WriteJSONOpt(newTypeNames bool, short bool, w []byte, m `)
				qw422016.N().S(typeString)
				qw422016.N().S(` `)
				qw422016.N().S(natDecl)
				qw422016.N().S(`) `)
				qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
				qw422016.N().S(` {
    keys := make([]`)
				qw422016.N().S(keyTypeString)
				qw422016.N().S(`, 0, len(m))
    for k := range m {
        keys = append(keys, k)
    }
`)
				directImports.importSort = true

				qw422016.N().S(`    sort.Slice(keys, func(i, j int) bool {
        return keys[i] < keys[j]
    })
    w = append(w, '{')
    for _, key := range keys {
        value := m[key]
        w = basictl.JSONAddCommaIfNeeded(w)
        w = append(w, `)
				qw422016.N().S("`")
				qw422016.N().S(`"`)
				qw422016.N().S("`")
				qw422016.N().S(`...)
        `)
				qw422016.N().S(tuple.dictKeyField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "key", formatNatArgs(nil, tuple.dictKeyField.natArgs), false, tuple.dictKeyField.t.hasErrorInWriteMethods))
				qw422016.N().S(`
        w = append(w, `)
				qw422016.N().S("`")
				qw422016.N().S(`":`)
				qw422016.N().S("`")
				qw422016.N().S(`...)
        `)
				qw422016.N().S(tuple.dictValueField.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "value", formatNatArgs(nil, tuple.dictValueField.natArgs), false, tuple.dictValueField.t.hasErrorInWriteMethods))
				qw422016.N().S(`
    }
`)
				if writeElementNeedsError {
					qw422016.N().S(`    return append(w, '}'), nil
`)
				} else {
					qw422016.N().S(`    return append(w, '}')
`)
				}
				qw422016.N().S(`}
`)
			}
		}
	case tuple.vectorLike:
		if tuple.wr.gen.options.GenerateRandomCode {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`FillRandom(rg *basictl.RandGenerator, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) {
    rg.IncreaseDepth()
    l := rg.LimitValue(basictl.RandomUint(rg))
    *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, l)
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeRandomCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", formatNatArgs(nil, tuple.element.natArgs), false))
			qw422016.N().S(`
    }
    rg.DecreaseDepth()
}
`)
		}
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Read(w []byte, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
    var l uint32
    if w, err = basictl.NatRead(w, &l); err != nil {
        return w, err
    }
`)
		if tuple.wr.gen.options.UseCheckLengthSanity {
			qw422016.N().S(`    if err = basictl.CheckLengthSanity(w, l, 4); err != nil {
        return w, err
    }
`)
		}
		qw422016.N().S(`    if uint32(cap(*vec)) < l {
        *vec = make([]`)
		qw422016.N().S(elementTypeString)
		qw422016.N().S(`, l)
    } else {
        *vec = (*vec)[:l]
    }
    for i := range *vec {
        `)
		qw422016.N().S(tuple.element.t.TypeReadingCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false))
		qw422016.N().S(`
    }
    return w, nil
}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Write(w []byte, vec `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
    w = basictl.NatWrite(w, uint32(len(vec)))
    for _, elem := range vec {
        `)
		qw422016.N().S(tuple.element.t.TypeWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false, writeElementNeedsError))
		qw422016.N().S(`
    }
`)
		if writeElementNeedsError {
			qw422016.N().S(`    return w, nil
`)
		} else {
			qw422016.N().S(`    return w
`)
		}
		qw422016.N().S(`}
`)
		if tuple.wr.gen.options.GenerateTL2 {
			qw422016.N().S(`
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`CalculateLayout(sizes []int, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) []int {
    sizePosition := len(sizes)
    sizes = append(sizes, 0)

    for i := 0; i < len(*vec); i++ {
`)
			_, trivialSize := tuple.element.t.trw.tl2TrivialSize("(*vec)[i]", false, tuple.element.recursive)
			sizeValue := trivialSize
			if len(trivialSize) == 0 {
				sizeValue = "sizes[currentPosition]"
			}

			if len(trivialSize) == 0 {
				qw422016.N().S(`        currentPosition := len(sizes)
`)
			}
			qw422016.N().S(`        `)
			qw422016.N().S(tuple.element.t.CalculateLayout(bytesVersion, "sizes", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
        sizes[sizePosition] += `)
			qw422016.N().S(sizeValue)
			qw422016.N().S(`
`)
			if tuple.element.t.trw.isSizeWrittenInData() {
				qw422016.N().S(`        sizes[sizePosition] += basictl.TL2CalculateSize(`)
				qw422016.N().S(sizeValue)
				qw422016.N().S(`)
`)
			}
			qw422016.N().S(`    }
    return sizes
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`InternalWriteTL2(w []byte, sizes []int, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) ([]byte, []int) {
    currentSize := sizes[0]
    sizes = sizes[1:]

    w = basictl.TL2WriteSize(w, currentSize)
    if currentSize == 0 {
        return w, sizes
    }

    for i := 0; i < len(*vec); i++ {
        `)
			qw422016.N().S(tuple.element.t.WriteTL2Call(bytesVersion, "sizes", "w", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
    }
    return w, sizes
}


func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadTL2(r []byte, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) (_ []byte, err error) {
    saveR := r
    currentSize := 0
    if r, currentSize, err = basictl.TL2ParseSize(r); err != nil { return r, err }
    shift := currentSize + basictl.TL2CalculateSize(currentSize)

    *vec = (*vec)[:0]
    for len(saveR) < len(r) + shift {
        var elem `)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`
        `)
			qw422016.N().S(tuple.element.t.ReadTL2Call(bytesVersion, "r", "elem", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
        *vec = append(*vec, elem)
    }
    return r, nil
}
`)
		}
		qw422016.N().S(`
`)
		if tuple.wr.gen.options.GenerateLegacyJsonRead {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadJSONLegacy(legacyTypeNames bool, j interface{}, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) error {
    l, _arr, err := `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`JsonReadArray(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, j)
    if err != nil {
        return err
    }
    if cap(*vec) < l {
        *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, l)
    } else {
        *vec = (*vec)[:l]
    }
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_arr[i]", "(*vec)[i]", formatNatArgs(nil, tuple.element.natArgs), false))
			qw422016.N().S(`
    }
    return nil
}

`)
		}
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`ReadJSON(legacyTypeNames bool, in *basictl.JsonLexer, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) error {
    *vec = (*vec)[:cap(*vec)]
    index := 0
    if in != nil {
        in.Delim('[')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json array")
        }
        for ;!in.IsDelim(']'); index++ {
            if len(*vec) <= index {
                var newValue `)
		qw422016.N().S(elementTypeString)
		qw422016.N().S(`
                *vec = append(*vec, newValue)
                *vec = (*vec)[:cap(*vec)]
            }
            `)
		qw422016.N().S(tuple.element.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "(*vec)[index]", formatNatArgs(nil, tuple.element.natArgs), false))
		qw422016.N().S(`
             in.WantComma()
        }
        in.Delim(']')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json array's end")
        }
    }
    *vec = (*vec)[:index]
    return nil
}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSON(w []byte, vec `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
    return `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSONOpt(true, false, w, vec`)
		qw422016.N().S(natCall)
		qw422016.N().S(`)
}
func `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSONOpt(newTypeNames bool, short bool, w []byte, vec `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
    w = append(w, '[')
    for _, elem := range vec {
        w = basictl.JSONAddCommaIfNeeded(w)
        `)
		qw422016.N().S(tuple.element.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", formatNatArgs(nil, tuple.element.natArgs), false, writeElementNeedsError))
		qw422016.N().S(`
    }
`)
		if writeElementNeedsError {
			qw422016.N().S(`    return append(w, ']'), nil
`)
		} else {
			qw422016.N().S(`    return append(w, ']')
`)
		}
		qw422016.N().S(`}

`)
	case tuple.dynamicSize:
		if tuple.wr.gen.options.GenerateRandomCode {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`FillRandom(rg *basictl.RandGenerator, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) {
    rg.IncreaseDepth()
    *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, nat_n)
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeRandomCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", formatNatArgs(nil, tuple.element.natArgs), false))
			qw422016.N().S(`
    }
    rg.DecreaseDepth()
}
`)
		}
		qw422016.N().S(`
func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Read(w []byte, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
`)
		if tuple.wr.gen.options.UseCheckLengthSanity {
			qw422016.N().S(`    if err = basictl.CheckLengthSanity(w, nat_n, 4); err != nil {
        return w, err
    }
`)
		}
		qw422016.N().S(`    if uint32(cap(*vec)) < nat_n {
        *vec = make([]`)
		qw422016.N().S(elementTypeString)
		qw422016.N().S(`, nat_n)
    } else {
        *vec = (*vec)[:nat_n]
    }
    for i := range *vec {
        `)
		qw422016.N().S(tuple.element.t.TypeReadingCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false))
		qw422016.N().S(`
    }
    return w, nil
}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Write(w []byte, vec `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
    if uint32(len(vec)) != nat_n {
        return w, `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorWrongSequenceLength(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, len(vec), nat_n)
    }
    for _, elem := range vec {
        `)
		qw422016.N().S(tuple.element.t.TypeWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false, writeElementNeedsError))
		qw422016.N().S(`
    }
    return w, nil
}
`)
		if tuple.wr.gen.options.GenerateTL2 {
			qw422016.N().S(`
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`CalculateLayout(sizes []int, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) []int {
    sizePosition := len(sizes)
    sizes = append(sizes, 0)

    for i := 0; i < len(*vec); i++ {
`)
			_, trivialSize := tuple.element.t.trw.tl2TrivialSize("(*vec)[i]", false, tuple.element.recursive)
			sizeValue := trivialSize
			if len(trivialSize) == 0 {
				sizeValue = "sizes[currentPosition]"
			}

			if len(trivialSize) == 0 {
				qw422016.N().S(`        currentPosition := len(sizes)
`)
			}
			qw422016.N().S(`        `)
			qw422016.N().S(tuple.element.t.CalculateLayout(bytesVersion, "sizes", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
        sizes[sizePosition] += `)
			qw422016.N().S(sizeValue)
			qw422016.N().S(`
`)
			if tuple.element.t.trw.isSizeWrittenInData() {
				qw422016.N().S(`        sizes[sizePosition] += basictl.TL2CalculateSize(`)
				qw422016.N().S(sizeValue)
				qw422016.N().S(`)
`)
			}
			qw422016.N().S(`    }
    return sizes
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`InternalWriteTL2(w []byte, sizes []int, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) ([]byte, []int) {
    currentSize := sizes[0]
    sizes = sizes[1:]

    w = basictl.TL2WriteSize(w, currentSize)
    if currentSize == 0 {
        return w, sizes
    }

    for i := 0; i < len(*vec); i++ {
        `)
			qw422016.N().S(tuple.element.t.WriteTL2Call(bytesVersion, "sizes", "w", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
    }
    return w, sizes
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadTL2(r []byte, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) (_ []byte, err error) {
    saveR := r
    currentSize := 0
    if r, currentSize, err = basictl.TL2ParseSize(r); err != nil { return r, err }
    shift := currentSize + basictl.TL2CalculateSize(currentSize)

    if uint32(cap(*vec)) < nat_n {
        *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, nat_n)
    } else {
        *vec = (*vec)[:nat_n]
    }
    i := 0
    for len(saveR) < len(r) + shift {
        if uint32(i) == nat_n {
            return r, basictl.TL2Error("more elements than expected")
        }
        `)
			qw422016.N().S(tuple.element.t.ReadTL2Call(bytesVersion, "r", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
        i += 1
    }
    if uint32(i) != nat_n {
        return r, basictl.TL2Error("less elements than expected")
    }
    return r, nil
}
`)
		}
		if tuple.wr.gen.options.GenerateLegacyJsonRead {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadJSONLegacy(legacyTypeNames bool, j interface{}, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) error {
    _, _arr, err := `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`JsonReadArrayFixedSize(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, j, nat_n)
    if err != nil {
        return err
    }
    if uint32(cap(*vec)) < nat_n {
        *vec = make([]`)
			qw422016.N().S(elementTypeString)
			qw422016.N().S(`, nat_n)
    } else {
        *vec = (*vec)[:nat_n]
    }
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_arr[i]", "(*vec)[i]", formatNatArgs(nil, tuple.element.natArgs), false))
			qw422016.N().S(`
    }
    return nil
}

`)
		}
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`ReadJSON(legacyTypeNames bool, in *basictl.JsonLexer, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) error {
    if uint32(cap(*vec)) < nat_n {
        *vec = make([]`)
		qw422016.N().S(elementTypeString)
		qw422016.N().S(`, nat_n)
    } else {
        *vec = (*vec)[:nat_n]
    }
    index := 0
    if in != nil {
        in.Delim('[')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json array")
        }
        for ;!in.IsDelim(']'); index++ {
            if nat_n <= uint32(index) {
                return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "array is longer than expected")
            }
            `)
		qw422016.N().S(tuple.element.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "(*vec)[index]", formatNatArgs(nil, tuple.element.natArgs), false))
		qw422016.N().S(`
             in.WantComma()
        }
        in.Delim(']')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json array's end")
        }
    }
    if uint32(index) != nat_n {
        return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorWrongSequenceLength(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, index, nat_n)
    }
    return nil
}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSON(w []byte, vec `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
    return `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSONOpt(true, false, w, vec`)
		qw422016.N().S(natCall)
		qw422016.N().S(`)
}
func `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSONOpt(newTypeNames bool, short bool, w []byte, vec `)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
    if uint32(len(vec)) != nat_n {
        return w, `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorWrongSequenceLength(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, len(vec), nat_n)
    }
    w = append(w, '[')
    for _, elem := range vec {
        w = basictl.JSONAddCommaIfNeeded(w)
        `)
		qw422016.N().S(tuple.element.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", formatNatArgs(nil, tuple.element.natArgs), false, writeElementNeedsError))
		qw422016.N().S(`
    }
    return append(w, ']'), nil
}

`)
	default:
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Reset(vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(`) {
    for i := range *vec {
            `)
		qw422016.N().S(tuple.element.t.TypeResettingCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", false))
		qw422016.N().S(`
    }
}

`)
		if tuple.wr.gen.options.GenerateRandomCode {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`FillRandom(rg *basictl.RandGenerator, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) {
    rg.IncreaseDepth()
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeRandomCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", formatNatArgs(nil, tuple.element.natArgs), false))
			qw422016.N().S(`
    }
    rg.DecreaseDepth()
}
`)
		}
		qw422016.N().S(`
func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Read(w []byte, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) (_ []byte, err error) {
    for i := range *vec {
        `)
		qw422016.N().S(tuple.element.t.TypeReadingCode(bytesVersion, directImports, tuple.wr.ins, "(*vec)[i]", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false))
		qw422016.N().S(`
    }
    return w, nil
}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`Write(w []byte, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
    for _, elem := range *vec {
        `)
		qw422016.N().S(tuple.element.t.TypeWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", tuple.element.Bare(), formatNatArgs(nil, tuple.element.natArgs), false, false, writeElementNeedsError))
		qw422016.N().S(`
    }
`)
		if writeElementNeedsError {
			qw422016.N().S(`    return w, nil
`)
		} else {
			qw422016.N().S(`    return w
`)
		}
		qw422016.N().S(`}
`)
		if tuple.wr.gen.options.GenerateTL2 {
			qw422016.N().S(`
func `)
			qw422016.N().S(goName)
			qw422016.N().S(`CalculateLayout(sizes []int, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) []int {
    sizePosition := len(sizes)
    sizes = append(sizes, 0)

    for i := 0; i < len(*vec); i++ {
`)
			_, trivialSize := tuple.element.t.trw.tl2TrivialSize("(*vec)[i]", false, tuple.element.recursive)
			sizeValue := trivialSize
			if len(trivialSize) == 0 {
				sizeValue = "sizes[currentPosition]"
			}

			if len(trivialSize) == 0 {
				qw422016.N().S(`        currentPosition := len(sizes)
`)
			}
			qw422016.N().S(`        `)
			qw422016.N().S(tuple.element.t.CalculateLayout(bytesVersion, "sizes", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
        sizes[sizePosition] += `)
			qw422016.N().S(sizeValue)
			qw422016.N().S(`
`)
			if tuple.element.t.trw.isSizeWrittenInData() {
				qw422016.N().S(`        sizes[sizePosition] += basictl.TL2CalculateSize(`)
				qw422016.N().S(sizeValue)
				qw422016.N().S(`)
`)
			}
			qw422016.N().S(`    }
    return sizes
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`InternalWriteTL2(w []byte, sizes []int, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) ([]byte, []int) {
    currentSize := sizes[0]
    sizes = sizes[1:]

    w = basictl.TL2WriteSize(w, currentSize)
    if currentSize == 0 {
        return w, sizes
    }

    for i := 0; i < len(*vec); i++ {
        `)
			qw422016.N().S(tuple.element.t.WriteTL2Call(bytesVersion, "sizes", "w", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
    }
    return w, sizes
}

func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadTL2(r []byte, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) (_ []byte, err error) {
    saveR := r
    currentSize := 0
    if r, currentSize, err = basictl.TL2ParseSize(r); err != nil { return r, err }
    shift := currentSize + basictl.TL2CalculateSize(currentSize)

    i := 0
    for len(saveR) < len(r) + shift {
            if i == `)
			qw422016.N().V(tuple.size)
			qw422016.N().S(` {
            return r, basictl.TL2Error("more elements than expected")
        }
        `)
			qw422016.N().S(tuple.element.t.ReadTL2Call(bytesVersion, "r", "(*vec)[i]", false, tuple.wr.ins, false, formatNatArgs(nil, tuple.element.natArgs)))
			qw422016.N().S(`
        i += 1
    }
    if i != `)
			qw422016.N().V(tuple.size)
			qw422016.N().S(` {
        return r, basictl.TL2Error("less elements than expected")
    }
    return r, nil
}
`)
		}
		qw422016.N().S(`
`)
		if tuple.wr.gen.options.GenerateLegacyJsonRead {
			qw422016.N().S(`func `)
			qw422016.N().S(goName)
			qw422016.N().S(`ReadJSONLegacy(legacyTypeNames bool, j interface{}, vec *`)
			qw422016.N().S(typeString)
			qw422016.N().S(` `)
			qw422016.N().S(natDecl)
			qw422016.N().S(`) error {
    _, _arr, err := `)
			qw422016.N().S(tuple.wr.gen.InternalPrefix())
			qw422016.N().S(`JsonReadArrayFixedSize(`)
			qw422016.N().Q(typeString)
			qw422016.N().S(`, j, `)
			qw422016.E().V(tuple.size)
			qw422016.N().S(`)
    if err != nil {
        return err
    }
    for i := range *vec {
        `)
			qw422016.N().S(tuple.element.t.TypeJSONReadingCode(bytesVersion, directImports, tuple.wr.ins, "_arr[i]", "(*vec)[i]", formatNatArgs(nil, tuple.element.natArgs), false))
			qw422016.N().S(`
    }
    return nil
}

`)
		}
		qw422016.N().S(`func `)
		qw422016.N().S(goName)
		qw422016.N().S(`ReadJSON(legacyTypeNames bool, in *basictl.JsonLexer, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) error {
    index := 0
    if in != nil {
        in.Delim('[')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json array")
        }
        for ;!in.IsDelim(']'); index++ {
            if index == `)
		qw422016.E().V(tuple.size)
		qw422016.N().S(` {
                return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorWrongSequenceLength(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, index + 1, `)
		qw422016.E().V(tuple.size)
		qw422016.N().S(`)
            }
            `)
		qw422016.N().S(tuple.element.t.TypeJSON2ReadingCode(bytesVersion, directImports, tuple.wr.ins, "in", "(*vec)[index]", formatNatArgs(nil, tuple.element.natArgs), false))
		qw422016.N().S(`
            in.WantComma()
        }
        in.Delim(']')
        if !in.Ok() {
            return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorInvalidJSON(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, "expected json array's end")
        }
    }
    if index != `)
		qw422016.E().V(tuple.size)
		qw422016.N().S(` {
        return `)
		qw422016.N().S(tuple.wr.gen.InternalPrefix())
		qw422016.N().S(`ErrorWrongSequenceLength(`)
		qw422016.N().Q(typeString)
		qw422016.N().S(`, index + 1, `)
		qw422016.E().V(tuple.size)
		qw422016.N().S(`)
    }
    return nil
}

func `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSON(w []byte, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
    return `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSONOpt(true, false, w, vec`)
		qw422016.N().S(natCall)
		qw422016.N().S(`)
}
func `)
		qw422016.N().S(goName)
		qw422016.N().S(`WriteJSONOpt(newTypeNames bool, short bool, w []byte, vec *`)
		qw422016.N().S(typeString)
		qw422016.N().S(` `)
		qw422016.N().S(natDecl)
		qw422016.N().S(`) `)
		qw422016.N().S(wrapWithError(writeElementNeedsError, "[]byte"))
		qw422016.N().S(` {
    w = append(w, '[')
    for _, elem := range *vec {
        w = basictl.JSONAddCommaIfNeeded(w)
        `)
		qw422016.N().S(tuple.element.t.TypeJSONWritingCode(bytesVersion, directImports, tuple.wr.ins, "elem", formatNatArgs(nil, tuple.element.natArgs), false, writeElementNeedsError))
		qw422016.N().S(`
    }
`)
		if writeElementNeedsError {
			qw422016.N().S(`    return append(w, ']'), nil
`)
		} else {
			qw422016.N().S(`    return append(w, ']')
`)
		}
		qw422016.N().S(`}
`)
	}
}

func (tuple *TypeRWBrackets) WriteGenerateCode(qq422016 qtio422016.Writer, bytesVersion bool, directImports *DirectImports) {
	qw422016 := qt422016.AcquireWriter(qq422016)
	tuple.StreamGenerateCode(qw422016, bytesVersion, directImports)
	qt422016.ReleaseWriter(qw422016)
}

func (tuple *TypeRWBrackets) GenerateCode(bytesVersion bool, directImports *DirectImports) string {
	qb422016 := qt422016.AcquireByteBuffer()
	tuple.WriteGenerateCode(qb422016, bytesVersion, directImports)
	qs422016 := string(qb422016.B)
	qt422016.ReleaseByteBuffer(qb422016)
	return qs422016
}
