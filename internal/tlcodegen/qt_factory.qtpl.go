// Copyright 2022 V Kontakte LLC
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, v. 2.0. If a copy of the MPL was not distributed with this
// file, You can obtain one at https://mozilla.org/MPL/2.0/.

// Code generated by qtc from "qt_factory.qtpl". DO NOT EDIT.
// See https://github.com/valyala/quicktemplate for details.

package tlcodegen

import (
	"fmt"
	"sort"

	"github.com/vkcom/tl/internal/tlast"

	qtio422016 "io"

	qt422016 "github.com/valyala/quicktemplate"
)

var (
	_ = qtio422016.Copy
	_ = qt422016.AcquireByteBuffer
)

func (gen *Gen2) streamgenerateFactory(qw422016 *qt422016.Writer, sortedImports []string, directImports *DirectImports) {
	qw422016.N().S(HeaderComment)
	qw422016.N().S(`
`)
	typeWrappers := gen.generatedTypesList

	qw422016.N().S(`package `)
	qw422016.E().S(FactoryGoPackageName)
	qw422016.N().S(`

import (
    "`)
	qw422016.N().S(gen.MetaPackageName)
	qw422016.N().S(`"
`)
	for _, wr := range sortedImports {
		qw422016.N().S(`    "`)
		qw422016.N().S(gen.options.TLPackageNameFull)
		qw422016.N().S(`/`)
		qw422016.N().S(wr)
		qw422016.N().S(`"
`)
	}
	qw422016.N().S(`)

func CreateFunction(tag uint32) meta.Function {
    return meta.CreateFunction(tag)
}

func CreateObject(tag uint32) meta.Object {
    return meta.CreateObject(tag)
}

// name can be in any of 3 forms "ch_proxy.insert#7cf362ba", "ch_proxy.insert" or "#7cf362ba"
func CreateFunctionFromName(name string) meta.Function {
    return meta.CreateFunctionFromName(name)
}

// name can be in any of 3 forms "ch_proxy.insert#7cf362ba", "ch_proxy.insert" or "#7cf362ba"
func CreateObjectFromName(name string) meta.Object {
    return meta.CreateObjectFromName(name)
}

func init() {
`)
	for _, wr := range typeWrappers {
		if wr.tlTag == 0 || !wr.isTopLevel {
			continue
		}
		if fun, ok := wr.trw.(*TypeRWStruct); ok && len(wr.NatParams) == 0 {
			tlTag := fmt.Sprintf("%#08x", wr.tlTag)

			if wr.unionParent != nil && wr.unionIsEnum {
				qw422016.N().S(`            meta.SetGlobalFactoryCreateForEnumElement(`)
				qw422016.E().S(tlTag)
				qw422016.N().S(`)
`)
				continue
			}
			qw422016.N().S(`    `)
			if fun.ResultType != nil {
				qw422016.N().S(`meta.SetGlobalFactoryCreateForFunction(`)
				qw422016.N().S(tlTag)
				qw422016.N().S(`,func() meta.Object { var ret`)
				qw422016.N().S(` `)
				qw422016.N().S(wr.TypeString2(false, directImports, nil, false, true))
				qw422016.N().S(`; return &ret },func() meta.Function { var ret`)
				qw422016.N().S(` `)
				qw422016.N().S(wr.TypeString2(false, directImports, nil, false, true))
				qw422016.N().S(`; return &ret }`)
			} else {
				qw422016.N().S(`meta.SetGlobalFactoryCreateForObject(`)
				qw422016.N().S(tlTag)
				qw422016.N().S(`,func() meta.Object { var ret`)
				qw422016.N().S(` `)
				qw422016.N().S(wr.TypeString2(false, directImports, nil, false, true))
				qw422016.N().S(`; return &ret }`)
			}
			qw422016.N().S(`)`)
			qw422016.N().S(`
`)
		}
	}
	qw422016.N().S(`}

`)
}

func (gen *Gen2) writegenerateFactory(qq422016 qtio422016.Writer, sortedImports []string, directImports *DirectImports) {
	qw422016 := qt422016.AcquireWriter(qq422016)
	gen.streamgenerateFactory(qw422016, sortedImports, directImports)
	qt422016.ReleaseWriter(qw422016)
}

func (gen *Gen2) generateFactory(sortedImports []string, directImports *DirectImports) string {
	qb422016 := qt422016.AcquireByteBuffer()
	gen.writegenerateFactory(qb422016, sortedImports, directImports)
	qs422016 := string(qb422016.B)
	qt422016.ReleaseByteBuffer(qb422016)
	return qs422016
}

func (gen *Gen2) streamgenerateConstants(qw422016 *qt422016.Writer, comment, pkgName string) {
	qw422016.N().S(comment)
	qw422016.N().S(`
package `)
	qw422016.N().S(pkgName)
	qw422016.N().S(`
`)
	sortedConstructors := make([]*tlast.Combinator, 0, len(gen.allConstructors))
	for _, c := range gen.allConstructors {
		if c.Crc32() == 0 {
			continue
		}
		sortedConstructors = append(sortedConstructors, c)
	}
	sort.Slice(sortedConstructors, func(i, j int) bool {
		return sortedConstructors[i].Construct.Name.String() < sortedConstructors[j].Construct.Name.String()
	})

	qw422016.N().S(`const (
`)
	for _, c := range sortedConstructors {
		if c.Crc32() == 0 {
			continue
		}
		qw422016.N().S(`        `)
		qw422016.N().S(canonicalGoName(c.Construct.Name, ""))
		qw422016.N().S(` = `)
		qw422016.N().S(fmt.Sprintf("%#08x", c.Crc32()))
		qw422016.N().S(` // `)
		qw422016.N().S(c.Construct.Name.String())
		qw422016.N().S(`
`)
	}
	qw422016.N().S(`)
`)
}

func (gen *Gen2) writegenerateConstants(qq422016 qtio422016.Writer, comment, pkgName string) {
	qw422016 := qt422016.AcquireWriter(qq422016)
	gen.streamgenerateConstants(qw422016, comment, pkgName)
	qt422016.ReleaseWriter(qw422016)
}

func (gen *Gen2) generateConstants(comment, pkgName string) string {
	qb422016 := qt422016.AcquireByteBuffer()
	gen.writegenerateConstants(qb422016, comment, pkgName)
	qs422016 := string(qb422016.B)
	qt422016.ReleaseByteBuffer(qb422016)
	return qs422016
}
